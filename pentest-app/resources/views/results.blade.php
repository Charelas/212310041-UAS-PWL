<!-- resources/views/results.blade.php -->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analysis Result - Pentest URL Analyzer</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
    <style>
        .jumbotron {
            background-color: #007bff;
            color: white;
            margin-bottom: 0;
        }
        .jumbotron h1 {
            font-weight: bold;
        }
        .result-container {
            background: #fff;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            margin-top: 20px;
        }
        .btn-primary {
            background-color: #007bff;
            border-color: #007bff;
        }
        .btn-primary:hover {
            background-color: #0056b3;
            border-color: #004085;
        }
        .preformatted {
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        /* modal Alert */
        .modal-content.secure {
            background-color: #d4edda;
            color: #155724;
        }
        .modal-content.not-secure {
            background-color: #f8d7da;
            color: #721c24;
        }

        /* Loading Animation CSS */
        #loading {
            position: fixed;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(0,0,0,.1);
            border-radius: 50%;
            border-left-color: #3498db;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    @include('navbar')
    <div class="jumbotron text-center">
        <div class="container mt-5">
            <h1>Analysis Result</h1>
            <p class="lead">Here are the details of your URL analysis</p>
        </div>
    </div>
    <div class="container">
        <div class="result-container">
            <h2>URL: {{ $url }}</h2>
            
            <!-- Headers Table -->
            <h3>Headers:</h3>
            <div class="table-responsive">
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th scope="col">Header Name</th>
                            <th scope="col">Header Value</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach ($headers_info as $headerName => $headerValue)
                            <tr>
                                <td>{{ $headerName }}</td>
                                <td>{{ is_array($headerValue) ? json_encode($headerValue) : $headerValue }}</td>
                            </tr>
                        @endforeach
                    </tbody>
                </table>
            </div>

            <!-- DNS Records Table -->
            <h3>DNS Records:</h3>
            <div class="table-responsive">
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th scope="col">Record Type</th>
                            <th scope="col">Record Value</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach ($dnsRecords as $recordType => $recordValues)
                            @foreach ($recordValues as $recordValue)
                                <tr>
                                    <td>{{ $recordType }}</td>
                                    <td>{{ is_array($recordValue) ? json_encode($recordValue) : $recordValue }}</td>
                                </tr>
                            @endforeach
                        @endforeach
                    </tbody>
                </table>
            </div>

            <!-- SSL Records -->
            <h3>SSL Records:</h3>

            <div class="table-responsive">
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th scope="col">Record Type</th>
                            <th scope="col">Record Value</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if(is_array($ssl_info))
                            @foreach ($ssl_info as $recordType => $recordValues)
                                @if(is_array($recordValues))
                                    @foreach ($recordValues as $recordValue)
                                        <tr>
                                            <td>{{ $recordType }}</td>
                                            <td>{{ is_array($recordValue) ? json_encode($recordValue) : $recordValue }}</td>
                                        </tr>
                                    @endforeach
                                @else
                                    <tr>
                                        <td>{{ $recordType }}</td>
                                        <td>{{ $recordValues }}</td>
                                    </tr>
                                @endif
                        @endforeach
                        @else
                            <tr>
                                <td colspan="2">{{ $ssl_info }}</td>
                            </tr>
                        @endif
                    </tbody>
                </table>
            </div>

            <!-- Shodan Information Table -->
            <h3>Shodan Information:</h3>
            <div class="table-responsive">
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th scope="col">Attribute</th>
                            <th scope="col">Value</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>IP Address</td>
                            <td>{{ $shodan_info['ip_str'] ?? 'N/A' }}</td>
                        </tr>
                        <tr>
                            <td>Hostnames</td>
                            <td>
                                <ul>
                                    @foreach ($shodan_info['hostnames'] ?? [] as $hostname)
                                        <li>{{ $hostname }}</li>
                                    @endforeach
                                </ul>
                            </td>
                        </tr>
                        <tr>
                            <td>Ports</td>
                            <td>
                                <ul>
                                    @foreach ($shodan_info['ports'] ?? [] as $port)
                                        <li>
                                            <strong>Port:</strong> {{ $port }}
                                            <ul>
                                                @foreach ($shodan_info['data'] ?? [] as $data)
                                                    @if ($data['port'] == $port)
                                                        <li><strong>Service:</strong> {{ $data['product'] ?? 'N/A' }}</li>
                                                        <li><strong>Version:</strong> {{ $data['version'] ?? 'N/A' }}</li>
                                                        <li><strong>Banner:</strong> <pre>{{ $data['banner'] ?? 'N/A' }}</pre></li>
                                                    @endif
                                                @endforeach
                                            </ul>
                                        </li>
                                    @endforeach
                                </ul>
                            </td>
                        </tr>
                        <tr>
                            <td>Vulnerabilities</td>
                            <td>
                                <ul>
                                    @foreach ($shodan_info['vulns'] ?? [] as $vuln)
                                        <li>
                                            {{ $vuln }}
                                            <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name={{ $vuln }}" target="_blank">More Info</a>
                                        </li>
                                    @endforeach
                                </ul>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Whois Information Table -->
            <h3>Whois Information:</h3>
            <div class="table-responsive">
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th scope="col">Attribute</th>
                            <th scope="col">Value</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach ($whois_info as $attribute => $value)
                            <tr>
                                <td>{{ $attribute }}</td>
                                <td>{{ is_array($value) ? json_encode($value) : $value }}</td>
                            </tr>
                        @endforeach
                    </tbody>
                </table>
            </div>

            <!-- Geo Location Table -->
            <h3>GeoIP Information:</h3>
            <div class="table-responsive">
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th scope="col">Attribute</th>
                            <th scope="col">Value</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach ($geoip_info as $attribute => $value)
                            <tr>
                                <td>{{ $attribute }}</td>
                                <td>{{ is_array($value) ? json_encode($value) : $value }}</td>
                            </tr>
                        @endforeach
                    </tbody>
                </table>
            </div>

            {{-- Reverse DNS Information --}}
            <h3>Reverse DNS Information:</h3>
            <div class="table-responsive">
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th scope="col">Attribute</th>
                            <th scope="col">Value</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach ($reverse_dns_info as $attribute => $value)
                            <tr>
                                <td>{{ $attribute }}</td>
                                <td>{{ is_array($value) ? json_encode($value) : $value }}</td>
                            </tr>
                        @endforeach
                    </tbody>
                </table>
            </div>

            {{-- Vuln Information --}}
            <h3>Vulnerability Information:</h3>
            <div class="table-responsive">
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th scope="col">Attribute</th>
                            <th scope="col">Value</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach ($vulnerability_info as $attribute => $value)
                            <tr>
                                <td>{{ $attribute }}</td>
                                <td>{{ is_array($value) ? json_encode($value) : $value }}</td>
                            </tr>
                        @endforeach
                    </tbody>
                </table>
            </div>

            {{-- Web Content Information --}}
            <h3>Web Content Information:</h3>
            <div class="table-responsive">
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th scope="col">Attribute</th>
                            <th scope="col">Value</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach ($web_content_info as $attribute => $value)
                            <tr>
                                <td>{{ $attribute }}</td>
                                <td>{{ is_array($value) ? json_encode($value) : $value }}</td>
                            </tr>
                        @endforeach
                    </tbody>
                </table>
            </div>

            {{-- URL Reputation Information --}}
            <h3>URL Reputation Information:</h3>
            <div class="table-responsive">
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th scope="col">Attribute</th>
                            <th scope="col">Value</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach ($url_reputation as $attribute => $value)
                            <tr>
                                <td>{{ $attribute }}</td>
                                <td>{{ is_array($value) ? json_encode($value) : $value }}</td>
                            </tr>
                        @endforeach
                    </tbody>
                </table>
            </div>

            {{-- Threat Intelligence Information --}}
            <h3>Threat Intelligence Information:</h3>
            @if(!empty($threat_intelligence))
            <div class="table-responsive">
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th scope="col">Attribute</th>
                            <th scope="col">Value</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach ($threat_intelligence as $attribute => $value)
                            <tr>
                                <td>{{ $attribute }}</td>
                                <td>{{ is_array($value) ? json_encode($value) : $value }}</td>
                            </tr>
                        @endforeach
                    </tbody>
                </table>
            </div>
            @else
                <p>No threat intelligence data was available.</p>
            @endif
        </div>

        {{-- Re-Analyze Form --}}
        <form action="{{ url('/analyze') }}" method="POST" id="analyze-form">
            @csrf
            <input type="hidden" name="url" value="{{ $url }}">
            <button type="submit" class="btn btn-primary btn-lg mt-3">Re-Analyze</button>
        </form>

        <!-- Loading Animation -->
        <div id="loading" style="display: none">
            <div class="spinner"></div>
        </div>

        {{-- <a href="{{ route('exportPDF', $scan->id) }}" class="btn btn-primary">Export to PDF</a> --}}

    </div>

    <!-- Modal ALERT -->
    <div class="modal fade" id="securityModal" tabindex="-1" role="dialog" aria-labelledby="securityModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content {{ $isSecure ? 'secure' : 'not-secure' }}">
                <div class="modal-header">
                    <h5 class="modal-title" id="securityModalLabel">{{ $isSecure ? 'Web Terindikasi Aman' : 'Web Terindikasi Tidak Aman' }}</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    {{ $isSecure ? 'Hasil analisis menunjukkan bahwa web ini aman.' : 'Hasil analisis menunjukkan bahwa web ini tidak aman.' }}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Tutup</button>
                </div>
            </div>
        </div>
    </div>

    @include('footer')

    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

    <script>
        $(document).ready(function() {
            $('#securityModal').modal('show');
        });
    </script>

    <script>
        $(document).ready(function() {
            $('#analyze-form').on('submit', function(e) {
                e.preventDefault();
                $('#loading').show();
                setTimeout(() => {
                    this.submit();
                }, 2000); // Delay for 2 seconds to show the loading animation
            });

            $(window).scroll(function() {
                if ($(this).scrollTop() > 50) { 
                    $('.navbar').addClass('scrolled');
                } else {
                    $('.navbar').removeClass('scrolled');
                }
            });
        });
    </script>
</body>
</html>
